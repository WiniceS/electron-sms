<template>
  <div class="deal">
    <el-row class="deal-input">
      <el-col :span="12">
        <el-input
          class="deal-input-goodid"
          v-model="goodNo"
          placeholder="请输入商品编号"
        ></el-input>
      </el-col>
      <el-col :span="4">
        <el-button
          class="deal-input-add"
          type="primary"
          @click="addGoodInSell"
        >添加</el-button>
      </el-col>
      <el-col :span="7">
        <span class="deal-sale">合计:{{sale}}元</span>
      </el-col>
    </el-row>
    <el-row class="deal-table">
      <el-table
        :data="dealRecords"
        stripe
        border
        :height="winHeight-130"
      >
        <el-table-column
          type="index"
          width="50"
        ></el-table-column>
        <el-table-column
          label="商品编号"
          width="180"
          prop="no"
        ></el-table-column>
        <el-table-column
          label="商品名称"
          width="180"
          prop="name"
        ></el-table-column>
        <el-table-column
          label="商品描述"
          min-width="180"
          prop="specification"
        ></el-table-column>
        <el-table-column
          label="商品类型"
          width="180"
          prop="varietyName"
        ></el-table-column>
        <el-table-column
          label="商品售价"
          width="180"
          prop="sell"
        ></el-table-column>
        <el-table-column
          label="商品数量"
          width="180"
          prop="quantity"
        >
          <template slot-scope="scope">
            <el-input-number
              v-model="scope.row.quantity"
              @change="handleChange(scope.row)"
              :min="0"
              size="mini"
            ></el-input-number>
          </template>
        </el-table-column>
        <el-table-column
          label="优惠"
          width="180"
          prop="discounts"
        >
          <template slot-scope="scope">
            <el-input-number
              v-model="scope.row.discounts"
              :min="0"
              :controls="false"
              size="mini"
            ></el-input-number>
          </template>
        </el-table-column>
        <el-table-column
          label="操作"
          min-width="60"
        >
          <template slot-scope="scope">
            <el-button
              size="mini"
              type="danger"
              @click="delDealList(scope.row.id)"
            >删除</el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-row>
    <el-row class="deal-button">
      <el-button
        type="warning"
        @click="clearDeal"
      >清空</el-button>
      <el-button
        type="primary"
        :style="{ width: '150px' }"
        @click="settleAccounts"
      >确认</el-button>
    </el-row>
  </div>
</template>

<script>
import { mapActions, mapState } from 'vuex'
export default {
  name: 'deal',
  data() {
    return {
      goodNo: '',
      dealRecords: []
    }
  },
  computed: {
    ...mapState(['winHeight']),
    sale() {
      let tmp = 0
      if (this.dealRecords.length > 0) {
        this.dealRecords.forEach(f => {
          tmp += f.sell * f.quantity - f.discounts
        })
      }
      return tmp
    }
  },
  methods: {
    ...mapActions('deal', ['sell']),
    ...mapActions('commodity', ['getByNo']),
    // 查询商品后添加到销售列表中
    addGoodInSell() {
      if (this.goodNo.length > 0) {
        const re = /^[0-9]{13}$/
        let tmp = this.goodNo.search(re)
        if (tmp > -1) {
          this.getByNo({ no: this.goodNo }).then(res => {
            res.quantity = 1
            res.discounts = 0
            this.dealRecords.push(res)
          })
          this.goodNo = ''
        } else {
          this.$message({
            type: 'warning',
            message: '请输入正确的商品编码'
          })
        }
      } else {
        this.$message({
          type: 'warning',
          message: '请输入商品编码'
        })
      }
    },
    handleChange(row) {
      if (Math.round(row.quantity) === 0) {
        this.handleDelete(row.id)
      }
    },
    // 删除一行销售商品
    handleDelete(id) {
      this.dealRecords = this.dealRecords.filter(f => f.id !== id)
    },
    // 清空销售列表
    clearDeal() {
      this.$confirm('是否清空销售列表', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      })
        .then(() => {
          this.dealRecords = []
        })
        .catch(() => {
          console.log('取消清空')
        })
    },
    // 结算
    settleAccounts() {
      this.sell({ record: this.dealRecords })
        .then(() => {
          this.goodNo = ''
        })
        .catch(e => {
          this.$message({
            type: 'error',
            message: '结算失败'
          })
        })
    }
  }
}
</script>

<style lang="scss">
.deal {
  .deal-input {
    height: 50px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    .deal-sale {
      font-size: 160%;
      font-weight: bold;
    }
  }
  .deal-table {
    width: calc(100% - 20px);
    margin: 5px 10px;
  }
  .deal-button {
    margin-top: 5px;
    margin-right: 10px;
    display: flex;
    justify-content: flex-end;
    align-items: center;
  }
}
</style>
